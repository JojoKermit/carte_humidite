<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte Humidité du Sol</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 15px 20px;
      padding: 0;
      /* Pas d'overflow:hidden, on laisse le scroll vertical naturel */
      background: #fff;
      color: #222;
    }

    h1 {
      font-size: 18px;
      margin-bottom: 8px;
      line-height: 1.2;
    }

    label, select {
      font-size: 14px;
      margin-right: 10px;
      vertical-align: middle;
    }

    #canvas {
      border: 1px solid #333;
      cursor: crosshair;
      display: block;
      margin-top: 10px;
      /* taille fixe */
      width: 1150px;
      height: 860px;
    }

    #tooltip {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid #444;
      padding: 6px 10px;
      font-size: 14px;
      pointer-events: none;
      display: none;
      border-radius: 4px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      white-space: nowrap;
      z-index: 100;
    }
  </style>
</head>
<body>
  <h1>Carte d'humidité du sol - Sélectionnez la date</h1>
  <label for="dateSelect">Date :</label>
  <select id="dateSelect" aria-label="Choisir une date disponible">
  </select>

  <canvas id="canvas" width="1150" height="860"></canvas>
  <div id="tooltip"></div>

  <script>
    const colorMap = [
      { r: 200, g: 0, b: 0, value: "< 5%" },
      { r: 212, g: 32, b: 19, value: "5-10%" },
      { r: 224, g: 66, b: 38, value: "10-15%" },
      { r: 236, g: 102, b: 62, value: "15-20%" },
      { r: 250, g: 135, b: 82, value: "20-25%" },
      { r: 252, g: 160, b: 93, value: "25-30%" },
      { r: 255, g: 188, b: 107, value: "30-35%" },
      { r: 255, g: 213, b: 122, value: "35-40%" },
      { r: 252, g: 234, b: 131, value: "40-45%" },
      { r: 245, g: 250, b: 140, value: "45-50%" },
      { r: 221, g: 250, b: 145, value: "50-55%" },
      { r: 205, g: 240, b: 145, value: "55-60%" },
      { r: 185, g: 230, b: 145, value: "60-65%" },
      { r: 160, g: 220, b: 155, value: "65-70%" },
      { r: 140, g: 210, b: 180, value: "70-75%" },
      { r: 120, g: 190, b: 195, value: "75-80%" },
      { r: 95, g: 165, b: 200, value: "80-85%" },
      { r: 70, g: 140, b: 200, value: "85-90%" },
      { r: 55, g: 120, b: 205, value: "90-95%" },
      { r: 55, g: 105, b: 210, value: ">95%" }
    ];

    const availableDates = {
      "19/06/2025": "Humidite_Sol_19062025.png",
      "25/07/2025": "Humidite_Sol_25072025.png",
      "17/08/2025": "Humidite_Sol_17082025.png",
      "01/09/2025": "Humidite_Sol_01092025.png",
      "10/09/2025": "Humidite_Sol_10092025.png"
    };

    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const tooltip = document.getElementById("tooltip");
    const dateSelect = document.getElementById("dateSelect");

    // Remplir le menu déroulant avec les dates dispo
    for (const date of Object.keys(availableDates)) {
      const option = document.createElement("option");
      option.value = date;
      option.textContent = date;
      dateSelect.appendChild(option);
    }

    // Image et date courante
    const img = new Image();
    // NE PAS utiliser crossOrigin ici, inutile en local et GitHub Pages

    // Ligne pixel à partir de laquelle on affiche l'image (tronquée en haut)
    const visibleYStart = 290;

    function loadImage(date) {
      const filename = availableDates[date];
      if (!filename) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        alert("Aucune carte disponible pour cette date.");
        return;
      }
      img.onload = () => {
        // On dessine uniquement la partie de l'image de y=290 à y=290 + canvas.height
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, visibleYStart, canvas.width, canvas.height, 0, 0, canvas.width, canvas.height);
      };
      img.onerror = () => {
        alert("Erreur de chargement de l'image !");
      };
      img.src = filename;
    }

    // Au changement de date, charger la nouvelle image
    dateSelect.addEventListener("change", (e) => {
      loadImage(e.target.value);
    });

    // Charger l'image initiale (première date dispo)
    const firstDate = Object.keys(availableDates)[0];
    dateSelect.value = firstDate;
    loadImage(firstDate);

    // Affichage du tooltip au survol du canvas
    canvas.addEventListener("mousemove", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor(e.clientX - rect.left);
      const y = Math.floor(e.clientY - rect.top);

      const pixel = ctx.getImageData(x, y, 1, 1).data;
      const [r, g, b] = [pixel[0], pixel[1], pixel[2]];
      const humidity = getApproximateColorValue(r, g, b);

      tooltip.style.left = `${e.pageX + 10}px`;
      tooltip.style.top = `${e.pageY + 10}px`;
      tooltip.innerHTML = `<strong>Humidité</strong>: ${humidity}`;
      tooltip.style.display = "block";
    });

    canvas.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });

    function getApproximateColorValue(r, g, b) {
      let closest = null;
      let minDistance = Infinity;

      for (const c of colorMap) {
        const distance = Math.sqrt(
          (c.r - r) ** 2 +
          (c.g - g) ** 2 +
          (c.b - b) ** 2
        );
        if (distance < minDistance) {
          minDistance = distance;
          closest = c;
        }
      }
      return minDistance <= 20 ? closest.value : `Valeur inconnue (RGB ${r}, ${g}, ${b})`;
    }
  </script>
</body>
</html>
