<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Humidité du sol</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #f9f9f9;
      height: 100%;
      overflow: hidden;
    }

    #container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
    }

    h1 {
      font-size: 18px;
      margin: 10px 0;
    }

    #controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    label {
      font-size: 14px;
      font-weight: bold;
    }

    select {
      font-size: 14px;
      padding: 4px 6px;
    }

    canvas {
      border: 1px solid #444;
      margin-top: 10px;
      width: 1150px;
      height: 860px; /* hauteur tronquée */
      image-rendering: pixelated;
      cursor: crosshair;
    }

    #tooltip {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.95);
      border: 1px solid #444;
      padding: 4px 8px;
      font-size: 13px;
      pointer-events: none;
      display: none;
      border-radius: 4px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="container">
    <h1>Humidité du sol</h1>
    <div id="controls">
      <label for="dateSelector">Date :</label>
      <select id="dateSelector"></select>
    </div>
    <canvas id="canvas" width="1150" height="860"></canvas>
  </div>

  <div id="tooltip"></div>

  <script>
    const visibleYStart = 290; // ligne de début de l'affichage
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const tooltip = document.getElementById("tooltip");
    const dateSelector = document.getElementById("dateSelector");
    const img = new Image();

    const availableDates = {
      "2025-06-19": "Humidite_Sol_19062025.png",
      "2025-07-25": "Humidite_Sol_25072025.png",
      "2025-08-17": "Humidite_Sol_17082025.png",
      "2025-09-01": "Humidite_Sol_01092025.png",
      "2025-09-10": "Humidite_Sol_10092025.png"
    };

    const colorMap = [
      { r: 200, g: 0, b: 0, value: "< 5%" },
      { r: 212, g: 32, b: 19, value: "5-10%" },
      { r: 224, g: 66, b: 38, value: "10-15%" },
      { r: 236, g: 102, b: 62, value: "15-20%" },
      { r: 250, g: 135, b: 82, value: "20-25%" },
      { r: 252, g: 160, b: 93, value: "25-30%" },
      { r: 255, g: 188, b: 107, value: "30-35%" },
      { r: 255, g: 213, b: 122, value: "35-40%" },
      { r: 252, g: 234, b: 131, value: "40-45%" },
      { r: 245, g: 250, b: 140, value: "45-50%" },
      { r: 221, g: 250, b: 145, value: "50-55%" },
      { r: 205, g: 240, b: 145, value: "55-60%" },
      { r: 185, g: 230, b: 145, value: "60-65%" },
      { r: 160, g: 220, b: 155, value: "65-70%" },
      { r: 140, g: 210, b: 180, value: "70-75%" },
      { r: 120, g: 190, b: 195, value: "75-80%" },
      { r: 95, g: 165, b: 200, value: "80-85%" },
      { r: 70, g: 140, b: 200, value: "85-90%" },
      { r: 55, g: 120, b: 205, value: "90-95%" },
      { r: 55, g: 105, b: 210, value: ">95%" }
    ];

    function formatDateFR(isoDate) {
      const [y, m, d] = isoDate.split("-");
      return `${d}/${m}/${y}`;
    }

    function populateDateSelector() {
      for (const dateISO in availableDates) {
        const option = document.createElement("option");
        option.value = dateISO;
        option.textContent = formatDateFR(dateISO);
        dateSelector.appendChild(option);
      }
    }

    function loadImage(date) {
      const filename = availableDates[date];
      if (!filename) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        alert("Aucune carte disponible pour cette date.");
        return;
      }

      img.src = filename;
    }

    img.onload = () => {
      const sourceHeight = img.height - visibleYStart;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(
        img,
        0, visibleYStart,               // Source : (x, y) dans l'image
        canvas.width, sourceHeight,     // Source : taille à prendre
        0, 0,                            // Destination : (x, y) sur le canvas
        canvas.width, sourceHeight      // Destination : taille dans le canvas
      );
    };

    img.onerror = () => {
      alert("Erreur de chargement de l'image !");
    };

    canvas.addEventListener("mousemove", (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) * (canvas.width / rect.width));
      const yInCanvas = Math.floor((e.clientY - rect.top) * (canvas.height / rect.height));
      const yInImage = yInCanvas + visibleYStart;

      const pixel = ctx.getImageData(x, yInCanvas, 1, 1).data;
      const [r, g, b] = [pixel[0], pixel[1], pixel[2]];
      const humidity = getApproximateColorValue(r, g, b);

      tooltip.style.left = `${e.pageX + 10}px`;
      tooltip.style.top = `${e.pageY + 10}px`;
      tooltip.innerHTML = `Humidité : ${humidity}`;
      tooltip.style.display = "block";
    });

    canvas.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });

    function getApproximateColorValue(r, g, b) {
      let closest = null;
      let minDistance = Infinity;

      for (const c of colorMap) {
        const distance = Math.sqrt((c.r - r) ** 2 + (c.g - g) ** 2 + (c.b - b) ** 2);
        if (distance < minDistance) {
          minDistance = distance;
          closest = c;
        }
      }

      return minDistance <= 20 ? closest.value : `Inconnue (RGB ${r}, ${g}, ${b})`;
    }

    // Initialisation
    populateDateSelector();
    const firstDate = dateSelector.options[0].value;
    dateSelector.value = firstDate;
    loadImage(firstDate);

    dateSelector.addEventListener("change", () => {
      loadImage(dateSelector.value);
    });
  </script>
</body>
</html>
